<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Dashboard - Katze</title>

    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">

    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .product-img-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .modal-body input,
        .modal-body select {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>


    <div class="container">
        <div class="admin-header">
            <h2>ðŸ“¦ Admin Dashboard</h2>
            <div>
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">Back to Site</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="products-tab" data-toggle="tab" href="#products" role="tab"
                    aria-controls="products" aria-selected="true">Products</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="orders-tab" data-toggle="tab" href="#orders" role="tab" aria-controls="orders"
                    aria-selected="false">Orders</a>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <!-- Products Tab -->
            <div class="tab-pane fade show active" id="products" role="tabpanel" aria-labelledby="products-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Product Management</h4>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addProductModal">Add New
                        Product</button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="product-list">
                                <!-- Loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Order Management</h4>
                    <div class="form-inline">
                        <label class="mr-2">Filter Status:</label>
                        <select id="orderStatusFilter" class="form-control form-control-sm">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="packed">Packed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Tracking #</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body">
                                    <!-- Loaded dynamically via admin-orders.js -->
                                    <tr>
                                        <td colspan="7" class="text-center">Loading orders...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Product</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <label>Name</label>
                        <input type="text" id="name" class="form-control" required>

                        <label>Category</label>
                        <select id="category" class="form-control" required>
                            <option value="Cats">Cats</option>
                            <option value="Dogs">Dogs</option>
                            <option value="Birds">Birds</option>
                            <option value="Other Animals">Other Animals</option>
                        </select>

                        <label>Price (â‚¹)</label>
                        <input type="number" id="price" class="form-control" required>

                        <label>Image</label>
                        <input type="file" id="imageFile" class="form-control" accept="image/*">
                        <small class="text-muted">Leave empty to keep existing image when editing.</small>

                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="inStock" checked>
                            <label class="form-check-label" for="inStock">In Stock</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery-1.11.3.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>

    <script type="module" src="js/admin-orders.js"></script>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { fetchProducts } from './js/db.js';
        import { addProduct, updateProduct, deleteProduct, uploadProductImage } from './js/admin-service.js';

        let products = [];
        let isEditing = false;

        // Security Check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    // Authorized
                    loadProducts();
                } else {
                    alert("Unauthorized access.");
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadProducts() {
            products = await fetchProducts(); // Reusing existing fetch
            const tbody = document.getElementById('product-list');
            tbody.innerHTML = '';

            products.forEach(p => {
                const stock = p.stock !== undefined ? p.stock : (p.inStock !== false ? 50 : 0);
                const stockBadge = stock > 0 ? `<span class="badge badge-success">${stock} in stock</span>` : `<span class="badge badge-danger">Out of Stock</span>`;

                const row = `
                    <tr>
                        <td><img src="${p.image_url || 'assets/img/products/product-img-1.jpg'}" class="product-img-thumb"></td>
                        <td>${p.name}</td>
                        <td>${p.category}</td>
                        <td>â‚¹${p.price}</td>
                        <td>
                            ${stockBadge}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="window.editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="window.removeProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        document.getElementById('saveProductBtn').addEventListener('click', async () => {
            // ... (Existing logic same as before, essentially)
            const btn = document.getElementById('saveProductBtn');
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const name = document.getElementById('name').value;
                const category = document.getElementById('category').value;
                const price = Number(document.getElementById('price').value);
                // We might want to add stock input in future for product editing too, but keeping simple for now
                // const inStock = document.getElementById('inStock').checked; 
                const file = document.getElementById('imageFile').files[0];
                const id = document.getElementById('productId').value;

                let imageUrl = null;
                if (file) {
                    imageUrl = await uploadProductImage(file);
                }

                const data = { name, category, price };
                // data.inStock = inStock; // Deprecated by stock count but keeping for compatibility if needed
                if (imageUrl) data.image_url = imageUrl;

                if (isEditing && id) {
                    await updateProduct(id, data);
                    alert("Product updated!");
                } else {
                    if (!imageUrl && !isEditing) data.image_url = "assets/img/products/product-img-1.jpg"; // Default
                    data.stock = 50; // Default stock for new products
                    await addProduct(data);
                    alert("Product added!");
                }

                $('#addProductModal').modal('hide');
                loadProducts();
                document.getElementById('productForm').reset();
                isEditing = false;

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Product";
            }
        });

        // Expose functions to window for onclick handlers
        window.editProduct = (id) => {
            const product = products.find(p => p.id === id);
            if (product) {
                isEditing = true;
                document.getElementById('modalTitle').innerText = "Edit Product";
                document.getElementById('productId').value = product.id;
                document.getElementById('name').value = product.name;
                document.getElementById('category').value = product.category;
                document.getElementById('price').value = product.price;
                // document.getElementById('inStock').checked = product.stock > 0;
                $('#addProductModal').modal('show');
            }
        };

        window.removeProduct = async (id) => {
            if (confirm("Are you sure you want to delete this product?")) {
                try {
                    await deleteProduct(id);
                    loadProducts();
                } catch (error) {
                    alert("Error deleting product: " + error.message);
                }
            }
        };

        // Reset modal on close
        $('#addProductModal').on('hidden.bs.modal', function () {
            document.getElementById('productForm').reset();
            document.getElementById('modalTitle').innerText = "Add Product";
            isEditing = false;
        });

    </script>
</body>

</html>